<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Maintenance Requests - Navadaya Girls Hostel</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .maintenance-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .maintenance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .maintenance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .student-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .student-details h4 {
            margin: 0 0 0.25rem 0;
            color: #333;
            font-size: 1.1rem;
        }
        
        .student-details p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .maintenance-type-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: capitalize;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .type-electrical { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .type-plumbing { background: #cce5ff; color: #004080; border: 1px solid #99d6ff; }
        .type-furniture { background: #e6f3e6; color: #2d5a2d; border: 1px solid #b3e6b3; }
        .type-cleaning { background: #f0e6ff; color: #4a0080; border: 1px solid #d1b3ff; }
        .type-acfan { background: #e0f7fa; color: #006064; border: 1px solid #b2ebf2; }
        .type-windowdoor { background: #ffecb3; color: #ff8f00; border: 1px solid #ffcc02; }
        .type-wifi { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; }
        .type-other { background: #f5f5f5; color: #666; border: 1px solid #ddd; }
        
        .priority-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-low {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .priority-medium {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .priority-high {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .priority-urgent {
            background: #dc3545;
            color: white;
            border: 1px solid #c82333;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-in-progress {
            background: #cce5ff;
            color: #004080;
            border: 1px solid #99d6ff;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .maintenance-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .detail-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .detail-item h5 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .detail-item p {
            margin: 0;
            color: #666;
        }
        
        .maintenance-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-progress {
            background: #007bff;
            color: white;
        }
        
        .btn-progress:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-complete {
            background: #28a745;
            color: white;
        }
        
        .btn-complete:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        
        .btn-reject:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .btn-delete {
            background: #6c757d;
            color: white;
        }
        
        .btn-delete:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card-mini {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-icon-mini {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.2rem;
        }
        
        .stat-icon-mini.pending {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
        }
        
        .stat-icon-mini.progress {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        
        .stat-icon-mini.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .stat-icon-mini.urgent {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }
        
        .no-maintenance {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .no-maintenance i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .maintenance-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .maintenance-details {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-home"></i>
                <span>Navadaya Admin</span>
            </div>
            
            <ul class="sidebar-menu">
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-chart-bar"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="rooms.html">
                        <i class="fas fa-bed"></i>
                        <span>Rooms</span>
                    </a>
                </li>
                <li>
                    <a href="students.html">
                        <i class="fas fa-users"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li>
                    <a href="fees.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Fees</span>
                    </a>
                </li>
                <li>
                    <a href="notices.html">
                        <i class="fas fa-bullhorn"></i>
                        <span>Notices</span>
                    </a>
                </li>
                <li>
                    <a href="complaints.html">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Complaints</span>
                    </a>
                </li>
                <li>
                    <a href="roomchangemanagement.html">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Room Changes</span>
                    </a>
                </li>
                <li>
                    <a href="leavemanagement.html">
                        <i class="fas fa-calendar-times"></i>
                        <span>Leave Applications</span>
                    </a>
                </li>
                <li class="active">
                    <a href="roommaintenancerequests.html">
                        <i class="fas fa-tools"></i>
                        <span>Maintenance Requests</span>
                    </a>
                </li>
                <li>
                    <a href="receipt-verification.html">
                        <i class="fas fa-shield-alt"></i>
                        <span>Receipt Verification</span>
                    </a>
                </li>
                <li class="separator">
                    <hr style="border: 1px solid #444; margin: 10px 0;">
                </li>
                <li>
                    <a href="student-portal.html" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 8px; color: white;">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Student Portal</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1><i class="fas fa-tools"></i> Room Maintenance Requests</h1>
                <div class="user-info">
                    <span id="userEmail"></span>
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <!-- Stats Overview -->
                <div class="stats-overview">
                    <div class="stat-card-mini">
                        <div class="stat-icon-mini pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3 id="pendingCount">0</h3>
                        <p>Pending Requests</p>
                    </div>
                    <div class="stat-card-mini">
                        <div class="stat-icon-mini progress">
                            <i class="fas fa-cog"></i>
                        </div>
                        <h3 id="progressCount">0</h3>
                        <p>In Progress</p>
                    </div>
                    <div class="stat-card-mini">
                        <div class="stat-icon-mini completed">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3 id="completedCount">0</h3>
                        <p>Completed</p>
                    </div>
                    <div class="stat-card-mini">
                        <div class="stat-icon-mini urgent">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 id="urgentCount">0</h3>
                        <p>Urgent Priority</p>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <h3><i class="fas fa-filter"></i> Filter Requests</h3>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="statusFilter">Status</label>
                            <select id="statusFilter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="typeFilter">Request Type</label>
                            <select id="typeFilter">
                                <option value="">All Types</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Cleaning">Cleaning</option>
                                <option value="AC/Fan">AC/Fan</option>
                                <option value="Window/Door">Window/Door</option>
                                <option value="WiFi">WiFi</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="priorityFilter">Priority</label>
                            <select id="priorityFilter">
                                <option value="">All Priorities</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="roomFilter">Room Number</label>
                            <input type="text" id="roomFilter" placeholder="Enter room number">
                        </div>
                        <div class="filter-group">
                            <label for="searchFilter">Search Student</label>
                            <input type="text" id="searchFilter" placeholder="Student name or roll number">
                        </div>
                    </div>
                </div>

                <!-- Maintenance Requests List -->
                <div id="maintenanceList">
                    <!-- Maintenance requests will be loaded here -->
                </div>

                <!-- No Requests Message -->
                <div id="noMaintenance" class="no-maintenance" style="display: none;">
                    <i class="fas fa-tools"></i>
                    <h3>No Maintenance Requests</h3>
                    <p>There are currently no maintenance requests to display.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc,
            orderBy,
            limit,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDA6duS8SJ5Wr26qNxzBoge01Leestj-9o",
            authDomain: "animal-planet-73497.firebaseapp.com",
            databaseURL: "https://animal-planet-73497-default-rtdb.firebaseio.com",
            projectId: "animal-planet-73497",
            storageBucket: "animal-planet-73497.appspot.com",
            messagingSenderId: "15025745338",
            appId: "1:15025745338:web:f2d2e2644d822afea00183",
            measurementId: "G-KP9582LMC3"
        };

        // Initialize Firebase
        console.log('Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        console.log('Firebase initialized successfully');

        class MaintenanceManager {
            constructor() {
                this.requests = [];
                this.filteredRequests = [];
                this.init();
            }

            async init() {
                try {
                    console.log('Initializing Maintenance Manager...');
                    this.setupEventListeners();
                    await this.loadRequests();
                } catch (error) {
                    console.error('Error initializing Maintenance Manager:', error);
                    this.showError(`Failed to initialize: ${error.message}`);
                }
            }

            setupEventListeners() {
                // Filter event listeners
                document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('priorityFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('roomFilter').addEventListener('input', () => this.applyFilters());
                document.getElementById('searchFilter').addEventListener('input', () => this.applyFilters());

                // Logout functionality
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }

            async loadRequests() {
                try {
                    console.log('Loading maintenance requests...');
                    const requestsRef = collection(db, 'maintenance');
                    console.log('Collection reference created');
                    
                    const querySnapshot = await getDocs(requestsRef);
                    console.log('Query executed, processing results...');
                    
                    this.requests = [];
                    querySnapshot.forEach((doc) => {
                        try {
                            const data = doc.data();
                            console.log('Processing document:', doc.id, data);
                            
                            this.requests.push({
                                id: doc.id,
                                ...data,
                                createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : (data.createdAt ? new Date(data.createdAt) : new Date()),
                                updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate() : (data.updatedAt ? new Date(data.updatedAt) : new Date())
                            });
                        } catch (docError) {
                            console.error('Error processing document:', doc.id, docError);
                        }
                    });
                    
                    console.log(`Processed ${this.requests.length} maintenance requests`);
                    
                    // Sort by priority (Urgent first) then by creation date
                    this.requests.sort((a, b) => {
                        const priorityOrder = { 'Urgent': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
                        const aPriority = priorityOrder[a.priority] || 4;
                        const bPriority = priorityOrder[b.priority] || 4;
                        
                        if (aPriority !== bPriority) {
                            return aPriority - bPriority;
                        }
                        return b.createdAt - a.createdAt;
                    });
                    
                    console.log(`Loaded and sorted ${this.requests.length} maintenance requests`);
                    this.filteredRequests = [...this.requests];
                    this.renderRequests();
                    this.updateStats();
                } catch (error) {
                    console.error('Error loading requests:', error);
                    console.error('Error details:', error.message, error.code);
                    this.showError(`Failed to load maintenance requests: ${error.message}`);
                    
                    // Show empty state if there's an error
                    this.filteredRequests = [];
                    this.renderRequests();
                    this.updateStats();
                }
            }

            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const roomFilter = document.getElementById('roomFilter').value.toLowerCase();
                const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

                this.filteredRequests = this.requests.filter(req => {
                    // Map status for filtering (Firebase uses different status names)
                    const mappedStatus = req.status === 'Open' ? 'pending' : 
                                       req.status === 'In Progress' ? 'in-progress' : 
                                       req.status.toLowerCase();
                    
                    // Status filter
                    if (statusFilter && mappedStatus !== statusFilter) return false;
                    
                    // Type filter - handle both 'issue' and 'type' fields
                    const issueType = req.issue || req.type || 'General';
                    if (typeFilter && issueType !== typeFilter) return false;
                    
                    // Priority filter
                    if (priorityFilter && req.priority !== priorityFilter) return false;
                    
                    // Room filter - handle both 'room' and 'roomNumber' fields
                    const roomNumber = req.room || req.roomNumber || '';
                    if (roomFilter && !roomNumber.toLowerCase().includes(roomFilter)) return false;
                    
                    // Search filter - handle different field names
                    if (searchFilter) {
                        const assignedTo = req.assignedTo || req.studentName || '';
                        const rollNumber = req.rollNumber || '';
                        const subject = req.subject || req.issue || '';
                        const searchText = `${assignedTo} ${rollNumber} ${subject}`.toLowerCase();
                        if (!searchText.includes(searchFilter)) return false;
                    }

                    return true;
                });

                this.renderRequests();
            }

            renderRequests() {
                console.log(`Rendering ${this.filteredRequests.length} requests`);
                const maintenanceList = document.getElementById('maintenanceList');
                const noMaintenance = document.getElementById('noMaintenance');

                if (this.filteredRequests.length === 0) {
                    console.log('No requests to display, showing empty state');
                    maintenanceList.innerHTML = '';
                    noMaintenance.style.display = 'block';
                    return;
                }

                console.log('Rendering request cards...');
                noMaintenance.style.display = 'none';
                try {
                    maintenanceList.innerHTML = this.filteredRequests.map(req => this.createMaintenanceCard(req)).join('');
                    console.log('Request cards rendered successfully');
                } catch (renderError) {
                    console.error('Error rendering requests:', renderError);
                    this.showError('Error displaying maintenance requests');
                }
            }

            createMaintenanceCard(req) {
                // Handle missing fields with defaults
                const assignedTo = req.assignedTo || req.studentName || 'Unknown';
                const roomNumber = req.room || req.roomNumber || 'N/A';
                const issueType = req.issue || req.type || 'General';
                const subject = req.subject || req.issue || 'Maintenance Request';
                const rollNumber = req.rollNumber || 'N/A';
                
                // Create initials from assignedTo or studentName
                const initials = assignedTo.split(' ').map(n => n[0]).join('').toUpperCase();
                
                const formattedDate = req.createdAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Map status values (Firebase uses different status names)
                const mappedStatus = req.status === 'Open' ? 'pending' : 
                                   req.status === 'In Progress' ? 'in-progress' : 
                                   req.status.toLowerCase();
                
                const statusClass = `status-${mappedStatus}`;
                const typeClass = `type-${issueType.toLowerCase().replace(/[^a-z]/g, '')}`;
                const priorityClass = `priority-${req.priority.toLowerCase()}`;
                
                const actionButtons = mappedStatus === 'pending' ? `
                    <button class="btn-action btn-progress" onclick="maintenanceManager.updateRequestStatus('${req.id}', 'in-progress')">
                        <i class="fas fa-cog"></i> Start Work
                    </button>
                    <button class="btn-action btn-complete" onclick="maintenanceManager.updateRequestStatus('${req.id}', 'completed')">
                        <i class="fas fa-check"></i> Complete
                    </button>
                    <button class="btn-action btn-reject" onclick="maintenanceManager.updateRequestStatus('${req.id}', 'rejected')">
                        <i class="fas fa-times"></i> Reject
                    </button>
                ` : mappedStatus === 'in-progress' ? `
                    <button class="btn-action btn-complete" onclick="maintenanceManager.updateRequestStatus('${req.id}', 'completed')">
                        <i class="fas fa-check"></i> Complete
                    </button>
                ` : '';

                return `
                    <div class="maintenance-card">
                        <div class="maintenance-header">
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div class="student-details">
                                    <h4>${assignedTo}</h4>
                                    <p>Roll No: ${rollNumber} • Room: ${roomNumber}</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <div class="maintenance-type-badge ${typeClass}">
                                    ${issueType}
                                </div>
                                <div class="priority-badge ${priorityClass}">
                                    ${req.priority}
                                </div>
                                <div class="status-badge ${statusClass}">
                                    ${mappedStatus}
                                </div>
                            </div>
                        </div>
                        
                        <div class="maintenance-details">
                            <div class="detail-item">
                                <h5><i class="fas fa-tag"></i> Subject</h5>
                                <p>${subject}</p>
                            </div>
                            <div class="detail-item">
                                <h5><i class="fas fa-calendar-plus"></i> Submitted Date</h5>
                                <p>${formattedDate}</p>
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <h5><i class="fas fa-comment"></i> Description</h5>
                                <p>${req.description}</p>
                            </div>
                        </div>
                        
                        <div class="maintenance-actions">
                            ${actionButtons}
                            <button class="btn-action btn-delete" onclick="maintenanceManager.deleteRequest('${req.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }

            async updateRequestStatus(requestId, newStatus) {
                try {
                    const requestRef = doc(db, 'maintenance', requestId);
                    await updateDoc(requestRef, {
                        status: newStatus,
                        updatedAt: new Date()
                    });

                    // Update local data
                    const request = this.requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = newStatus;
                        request.updatedAt = new Date();
                    }
                    
                    this.applyFilters();
                    this.updateStats();
                    this.showSuccess(`Request marked as ${newStatus} successfully!`);
                } catch (error) {
                    console.error('Error updating request status:', error);
                    this.showError('Failed to update request status');
                }
            }

            async deleteRequest(requestId) {
                if (!confirm('Are you sure you want to delete this maintenance request? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    const requestRef = doc(db, 'maintenance', requestId);
                    await deleteDoc(requestRef);

                    // Remove from local data
                    this.requests = this.requests.filter(r => r.id !== requestId);
                    
                    this.applyFilters();
                    this.updateStats();
                    this.showSuccess('Request deleted successfully!');
                } catch (error) {
                    console.error('Error deleting request:', error);
                    this.showError('Failed to delete request');
                }
            }

            updateStats() {
                // Map Firebase status names to expected values
                const pending = this.requests.filter(r => r.status === 'pending' || r.status === 'Open').length;
                const progress = this.requests.filter(r => r.status === 'in-progress' || r.status === 'In Progress').length;
                const completed = this.requests.filter(r => r.status === 'completed' || r.status === 'Completed').length;
                const urgent = this.requests.filter(r => r.priority === 'Urgent').length;

                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('progressCount').textContent = progress;
                document.getElementById('completedCount').textContent = completed;
                document.getElementById('urgentCount').textContent = urgent;
            }

            showSuccess(message) {
                this.showToast(message, '#28a745', 'fas fa-check');
            }

            showError(message) {
                this.showToast(message, '#dc3545', 'fas fa-exclamation-triangle');
            }

            showToast(message, color, icon) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${color};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                toast.innerHTML = `<i class="${icon}"></i> ${message}`;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }
        }

        // Initialize the manager
        console.log('Starting Maintenance Manager initialization...');
        const maintenanceManager = new MaintenanceManager();
        
        // Make it globally accessible for onclick handlers
        window.maintenanceManager = maintenanceManager;

        // Add CSS animation for toast
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>