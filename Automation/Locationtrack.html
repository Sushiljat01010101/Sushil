<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Command Center Pro</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animations */
        .pulse-ring {
            border: 3px solid #3b82f6; border-radius: 50%;
            height: 20px; width: 20px; position: absolute;
            animation: pulsate 1.5s ease-out infinite; opacity: 0;
        }
        @keyframes pulsate {
            0% { transform: scale(0.1); opacity: 1.0; }
            100% { transform: scale(2.5); opacity: 0.0; }
        }
        
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background-color: #ef4444; }

        /* Delete Button Hover Effect */
        .btn-delete:hover { background-color: #ef4444; color: white; border-color: #ef4444; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-full md:w-96 flex flex-col bg-slate-900 border-r border-slate-700 h-2/5 md:h-full z-20 shadow-2xl relative">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-700 bg-slate-900 sticky top-0 z-10">
            <div class="flex items-center justify-between mb-3">
                <h1 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-satellite-dish text-blue-500"></i> SkyTrack Pro
                </h1>
                <div class="flex items-center gap-2 px-2 py-1 bg-slate-800 rounded border border-slate-700">
                    <span id="connection-status" class="status-dot status-offline"></span>
                    <span id="status-text" class="text-[10px] font-bold text-slate-400 uppercase">Connecting...</span>
                </div>
            </div>

            <!-- FORCE UPDATE BUTTON -->
            <button onclick="triggerLocationUpdate()" id="update-btn"
                class="w-full mb-3 py-2.5 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-lg shadow-lg flex items-center justify-center gap-2 font-bold text-sm transition-all transform active:scale-95 border border-white/10">
                <i class="fa-solid fa-rotate"></i> Force Update Location
            </button>
            
            <!-- Stats -->
            <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700 backdrop-blur-sm grid grid-cols-2 gap-2">
                <div>
                    <p class="text-[10px] text-slate-400 uppercase font-bold">Device</p>
                    <p class="text-sm font-bold text-white truncate" id="device-name">--</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">Battery</p>
                    <div class="flex items-center justify-end gap-1 text-white font-bold text-sm" id="battery-display">
                        --%
                    </div>
                </div>
                <div class="col-span-2 border-t border-slate-700 pt-2 mt-1 flex justify-between items-center">
                    <span class="text-[10px] text-slate-500">Last Seen:</span>
                    <span class="text-[11px] text-blue-400 font-mono" id="last-seen">--</span>
                </div>
            </div>
        </div>

        <!-- Location List -->
        <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-900" id="location-list">
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center h-full text-slate-600 gap-2">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                <span class="text-xs">Waiting for data...</span>
            </div>
        </div>
    </aside>

    <!-- Map -->
    <main class="flex-1 relative h-3/5 md:h-full bg-slate-800">
        <div id="map"></div>
        
        <!-- Recenter Button -->
        <button onclick="fitMap()" class="absolute bottom-6 right-4 z-[1000] bg-slate-800 hover:bg-slate-700 text-white w-12 h-12 rounded-full shadow-2xl transition-all border border-slate-600 flex items-center justify-center">
            <i class="fa-solid fa-crosshairs"></i>
        </button>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDUe98t4j_xvAxSLPTYXb2Ju7HoL0WDXrc",
            authDomain: "animal-planet-73497.firebaseapp.com",
            databaseURL: "https://animal-planet-73497-default-rtdb.firebaseio.com",
            projectId: "animal-planet-73497",
            storageBucket: "animal-planet-73497.appspot.com",
            messagingSenderId: "15025745338",
            appId: "1:15025745338:web:313707915ad7b439a00183",
            measurementId: "G-KPENWL3DW3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Map Setup
        const map = L.map('map', { zoomControl: false }).setView([22.5937, 78.9629], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 20
        }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        const markersGroup = L.layerGroup().addTo(map);
        const polylineGroup = L.layerGroup().addTo(map);

        // --- REAL-TIME DATA ---
        const locationRef = ref(db, 'location');

        onValue(locationRef, (snapshot) => {
            const data = snapshot.val();
            updateStatus(!!data);

            if (data) {
                // Convert Object to Array (Keep ID for deletion)
                const locationArray = Object.entries(data).map(([key, value]) => ({
                    id: key, // Store Firebase Key
                    ...value,
                    lat: parseFloat(value.latitude),
                    lng: parseFloat(value.longitude),
                    ts: parseInt(value.timestamp),
                    bat: parseInt(value.battery_level)
                })).sort((a, b) => b.ts - a.ts);

                renderDashboard(locationArray);
            } else {
                // Handle empty state
                document.getElementById('location-list').innerHTML = 
                    '<div class="text-center text-slate-500 mt-10 text-xs">No location history found.</div>';
                markersGroup.clearLayers();
                polylineGroup.clearLayers();
            }
        });

        // --- DELETE FUNCTION (Exposed globally) ---
        window.deleteLocation = function(id) {
            if(confirm("Are you sure you want to delete this location record permanently?")) {
                remove(ref(db, `location/${id}`))
                    .then(() => {
                        Toastify({ text: "Location Deleted ðŸ—‘ï¸", duration: 2000, style: { background: "#ef4444" } }).showToast();
                    })
                    .catch((err) => {
                        alert("Error deleting: " + err.message);
                    });
            }
        };

        function updateStatus(isOnline) {
            const dot = document.getElementById('connection-status');
            const text = document.getElementById('status-text');
            if(isOnline) {
                dot.className = "status-dot status-online";
                text.innerText = "LIVE";
                text.className = "text-[10px] font-bold text-green-400 uppercase";
            } else {
                dot.className = "status-dot status-offline";
                text.innerText = "NO DATA";
                text.className = "text-[10px] font-bold text-red-400 uppercase";
            }
        }

        function renderDashboard(locations) {
            if (locations.length === 0) return;
            const latest = locations[0];
            const listContainer = document.getElementById('location-list');

            // Header Stats
            document.getElementById('device-name').innerText = latest.device_name || "Device";
            document.getElementById('last-seen').innerText = new Date(latest.ts).toLocaleString('en-IN');
            
            // Battery
            let batColor = latest.bat < 20 ? "text-red-500" : (latest.bat < 50 ? "text-yellow-400" : "text-green-400");
            let batIcon = latest.bat < 20 ? "fa-battery-quarter" : "fa-battery-full";
            document.getElementById('battery-display').innerHTML = `<span class="${batColor}">${latest.bat}%</span> <i class="fa-solid ${batIcon} ${batColor}"></i>`;

            // Clear UI
            listContainer.innerHTML = '';
            markersGroup.clearLayers();
            polylineGroup.clearLayers();

            const pathPoints = [];

            locations.forEach((loc, index) => {
                const isLatest = index === 0;
                pathPoints.push([loc.lat, loc.lng]);

                // Map Marker
                const circle = L.circleMarker([loc.lat, loc.lng], {
                    radius: isLatest ? 8 : 4,
                    fillColor: isLatest ? '#3b82f6' : '#64748b',
                    color: '#fff', weight: 1, opacity: 1, fillOpacity: isLatest ? 0.9 : 0.5
                });

                const gMapUrl = `https://www.google.com/maps?q=${loc.lat},${loc.lng}`;
                
                circle.bindPopup(`
                    <div class="text-sm min-w-[150px]">
                        <div class="font-bold border-b border-slate-600 pb-1 mb-1 text-slate-200">
                            ${loc.device_name}
                        </div>
                        <div class="mb-2 text-slate-400 text-xs">
                            ${new Date(loc.ts).toLocaleString()}<br>
                            Battery: ${loc.bat}%
                        </div>
                        <div class="flex gap-1">
                            <a href="${gMapUrl}" target="_blank" class="flex-1 text-center bg-blue-600 text-white py-1 rounded text-xs">G-Maps</a>
                            <button onclick="deleteLocation('${loc.id}')" class="flex-1 bg-red-600 text-white py-1 rounded text-xs">Delete</button>
                        </div>
                    </div>
                `);
                markersGroup.addLayer(circle);

                if (isLatest) {
                    const pulseIcon = L.divIcon({ className: 'pulse-ring', iconSize: [20,20], iconAnchor: [10,10] });
                    markersGroup.addLayer(L.marker([loc.lat, loc.lng], { icon: pulseIcon }));
                }

                // List Item
                const row = document.createElement('div');
                row.className = `p-3 rounded-lg border flex items-center gap-3 transition-all relative group
                    ${isLatest ? 'bg-slate-800 border-blue-500/50 shadow-lg' : 'bg-slate-800/30 border-slate-700/50 hover:bg-slate-700'}`;
                
                // Click on row (except buttons) focuses map
                row.onclick = (e) => {
                    if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A' && e.target.tagName !== 'I') {
                        map.flyTo([loc.lat, loc.lng], 16);
                        circle.openPopup();
                    }
                };

                row.innerHTML = `
                    <div class="flex-1 cursor-pointer">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">${loc.date}</span>
                            <span class="text-[10px] font-bold ${batColor}">${loc.bat}%</span>
                        </div>
                        <div class="text-xs font-mono text-white flex items-center gap-2">
                            ${new Date(loc.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            ${isLatest ? '<span class="text-[9px] bg-blue-600 px-1 rounded text-white">NOW</span>' : ''}
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center gap-1">
                        <a href="${gMapUrl}" target="_blank" class="h-7 w-7 flex items-center justify-center rounded bg-slate-700 text-slate-400 hover:bg-green-600 hover:text-white border border-slate-600 transition" title="Maps">
                            <i class="fa-solid fa-location-arrow text-xs"></i>
                        </a>
                        <button onclick="deleteLocation('${loc.id}')" class="h-7 w-7 flex items-center justify-center rounded bg-slate-700 text-slate-400 hover:bg-red-600 hover:text-white border border-slate-600 transition btn-delete" title="Delete">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                listContainer.appendChild(row);
            });

            if (pathPoints.length > 1) {
                const line = L.polyline(pathPoints, { color: '#3b82f6', weight: 2, opacity: 0.5, dashArray: '5, 5' });
                polylineGroup.addLayer(line);
            }
        }

        // --- GLOBAL: Force Update Logic ---
        window.fitMap = function() {
            if(markersGroup.getLayers().length) map.fitBounds(markersGroup.getBounds().pad(0.1));
        };

        window.triggerLocationUpdate = function() {
            const btn = document.getElementById('update-btn');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Requesting...';
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            
            fetch("https://trigger.macrodroid.com/9aa91e38-485b-482e-9a44-6ed77d27c2d3/f")
                .then(res => {
                    if(res.ok) Toastify({ text: "Update Requested! ðŸ›°ï¸", gravity: "top", position: "right", style: { background: "#10b981" } }).showToast();
                    else throw new Error("Failed");
                })
                .catch(() => Toastify({ text: "Request Failed âŒ", style: { background: "#ef4444" } }).showToast())
                .finally(() => {
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    }, 2000);
                });
        };
    </script>
</body>
  </html>
